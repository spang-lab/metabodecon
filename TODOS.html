<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Open • metabodecon</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="apple-touch-icon-60x60.png"><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Open"><meta property="og:image" content="https://spang-lab.github.io/metabodecon/logo.svg"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">metabodecon</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/Get_Started.html">Get Started</a></li>
    <li><a class="dropdown-item" href="articles/FAQ.html">FAQ</a></li>
    <li><a class="dropdown-item" href="articles/MetaboDecon1D.html">MetaboDecon1D</a></li>
    <li><a class="dropdown-item" href="articles/Datasets.html">Datasets</a></li>
    <li><a class="dropdown-item" href="articles/Contributing.html">Contributing</a></li>
    <li><a class="dropdown-item" href="articles/Compatibility.html">Compatibility</a></li>
    <li><a class="dropdown-item" href="articles/Classes.html">Metabodecon Classes</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/spang-lab/metabodecon/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="logo.svg" class="logo" alt=""><h1>Open</h1>
      <small class="dont-index">Source: <a href="https://github.com/spang-lab/metabodecon/blob/main/TODOS.md" class="external-link"><code>TODOS.md</code></a></small>
    </div>


<div id="open" class="section level1">

<div class="section level2">
<h2 id="v120">v1.2.0<a class="anchor" aria-label="anchor" href="#v120"></a></h2>
<div class="section level3">
<h3 id="feature-13-merge-into-main">FEATURE-13: Merge into main<a class="anchor" aria-label="anchor" href="#feature-13-merge-into-main"></a></h3>
<ul class="task-list"><li><label><input type="checkbox">Fix all R CMD Check findings.</label></li>
<li><label><input type="checkbox">Merge branch <code>v1.2.0</code> into <code>main</code>.</label></li>
</ul></div>
<div class="section level3">
<h3 id="cran-10-resubmit-to-cran">CRAN-10: Resubmit to CRAN<a class="anchor" aria-label="anchor" href="#cran-10-resubmit-to-cran"></a></h3>
<ul class="task-list"><li><label><input type="checkbox">Resubmit to CRAN.</label></li>
</ul></div>
<div class="section level3">
<h3 id="doc-2-improve-docs">DOC-2: Improve docs<a class="anchor" aria-label="anchor" href="#doc-2-improve-docs"></a></h3>
<ul class="task-list"><li><label><input type="checkbox">Add author descriptions to each function</label></li>
<li><label><input type="checkbox">Add lifecycle badges to each exported function</label></li>
<li><label><input type="checkbox">Ensure each exported function is used at least once in a vignette</label></li>
<li><label><input type="checkbox">Remove unused functions</label></li>
<li><label><input type="checkbox">Improve <code>Get_Started</code> by adding nicer plots</label></li>
<li><label><input type="checkbox">Write <code>Deconvolution_Details</code> vignette</label></li>
<li><label><input type="checkbox">Write <code>Alignment_Details</code> vignette</label></li>
</ul></div>
<div class="section level3">
<h3 id="doc-3-write-paper">DOC-3: Write paper<a class="anchor" aria-label="anchor" href="#doc-3-write-paper"></a></h3>
<p>Reformat the vignettes as paper and send to Wolfram for proofreading.</p>
</div>
</div>
<div class="section level2">
<h2 id="v13x">v1.3.x<a class="anchor" aria-label="anchor" href="#v13x"></a></h2>
<div class="section level3">
<h3 id="feature-8-warn-user-if-peaks-are-found-in-sfr">FEATURE-8: Warn user if peaks are found in SFR<a class="anchor" aria-label="anchor" href="#feature-8-warn-user-if-peaks-are-found-in-sfr"></a></h3>
<p>If delta is small (e.g. 1), peaks in SFR might not be filtered out. Either implement this and warn user about it (this is a strong indication that delta was chosen too small).</p>
</div>
<div class="section level3">
<h3 id="refactor-9-improve-mse_normed-calculation">REFACTOR-9: Improve mse_normed calculation<a class="anchor" aria-label="anchor" href="#refactor-9-improve-mse_normed-calculation"></a></h3>
<p>In function <code>add_return_list</code>:</p>
<ol style="list-style-type: decimal"><li>
<p>Make the following part faster (or remove completely):</p>
<p><code>s &lt;- sapply(x, function(x_i) sum(abs(A * (lambda / (lambda^2 + (x_i - w)^2))))) # takes approx. 2.2 seconds for urine_1</code></p>
</li>
<li><p>Return <code>mse_normed_raw</code> in addition to <code>mse_normed</code> (which is calculated based on <code>y &lt;- spec$y_smooth</code>). <code>mse_normed_raw</code> should be based on <code>y &lt;- spec$y_raw</code>.</p></li>
</ol></div>
<div class="section level3">
<h3 id="check-10-negative-values-for-estimated-a">CHECK-10: Negative values for estimated A<a class="anchor" aria-label="anchor" href="#check-10-negative-values-for-estimated-a"></a></h3>
<p>Check why there are negative values for the estimated lorentz curve area A.</p>
</div>
<div class="section level3">
<h3 id="feature-19-make-sfr-and-ws-defaults-dynamic">FEATURE-19: make SFR and WS defaults dynamic<a class="anchor" aria-label="anchor" href="#feature-19-make-sfr-and-ws-defaults-dynamic"></a></h3>
<p>Replace the default values <code>wshw = 0.1527692</code> and <code>sfr = c(11.44494, -1.8828)</code> in <code><a href="reference/deconvolute.html">generate_lorentz_curves()</a></code> with <code>wshw = "auto"</code> and <code>sfr = "auto"</code>, which should be calculated as follows:</p>
<p>If <code>c(11.44494, -1.8828)</code> is part of the ppm range, use these values, otherwise calculate them as</p>
<ol style="list-style-type: decimal"><li>
<code>wshw = 0.01 * width(cs)</code> (where <code>0.01</code> is <code>round(0.007629452, 2)</code> and <code>0.007629452</code> equals <code>0.1527692 / 20.0236144338963</code> which is the width of the default WSHW dividided by the width of the <code>urine_1</code> spectrum. I.e., the new calculation would give approximately the same proportion of the spectrum width as the default value.)</li>
<li><code>sfr = max(cs) - c(1/6, 5/6) * width(cs)</code></li>
</ol></div>
</div>
<div class="section level2">
<h2 id="v140">v1.4.0<a class="anchor" aria-label="anchor" href="#v140"></a></h2>
<div class="section level3">
<h3 id="feature-10-implement-deconvolute_spectra">FEATURE-10: Implement deconvolute_spectra<a class="anchor" aria-label="anchor" href="#feature-10-implement-deconvolute_spectra"></a></h3>
<p>Implement <code>deconvolute_spectra()</code> and <code>deconvolute_spectrum()</code> which should be the successors of <code>deconvolute_ispec()</code> and <code>deconvolute_ispecs()</code>. In particular it should:</p>
<ol style="list-style-type: decimal"><li>Accept <code>spectrum</code> objects as input (as returned by <code>read_spectra</code>). See <a href="#feature-9-implement-and-export-read_spectra">FEATURE-9</a>.</li>
<li>Use the correct SFR calculation as described in <a href="#check-2-signal-free-region-calculation">CHECK-2</a>.</li>
<li>Uses the correct water signal calculation as described in <a href="#check-3-water-signal-calculation">CHECK-3</a>.</li>
<li>Use 1-based indexing for data points as described in <a href="#check-4-data-point-format">CHECK-4</a>.</li>
<li>Remove the scale factor and scaled data point numbers as described in <a href="#check-4-data-point-format">CHECK-4</a>.</li>
<li>Remove negative values in a consistent way, as described by <a href="#check-5-signal-preprocessing">CHECK-5</a>
</li>
</ol></div>
<div class="section level3">
<h3 id="infra-1-create-issue-for-the-following-topics">INFRA-1: Create issue for the following topics<a class="anchor" aria-label="anchor" href="#infra-1-create-issue-for-the-following-topics"></a></h3>
<ul><li>Write a small wrapper to generate and store <code>aligned SI matrix</code>
</li>
<li>Check and refactor integral calculations</li>
<li>Check and refactor mse calculations</li>
<li>Improve prarp tests. The peak ratio should be calculated as nCorrectlyIdentifiedPeaks / (nPeaks + nFalselyDetectedPeaks)</li>
<li>Implement <a href="https://gitlab.spang-lab.de/bachelorthesis/ws2425_msombke_metabodecon-v2/-/blob/main/new_method_docs/main.R" class="external-link">Max’ parameter approximation algorithms</a> in <code>calc_A</code>, <code>calc_lambda</code> and <code>calc_w</code>.</li>
<li>Add testcase with 100 iterations</li>
<li>Add testcase with one big peak at 0.000 ppm (because it’s unclear why <a href="https://github.com/spang-lab/metabodecon/blob/v1.2.0/R/21_decon_helpers.R#L315" class="external-link uri">https://github.com/spang-lab/metabodecon/blob/v1.2.0/R/21_decon_helpers.R#L315</a> checks for w[i] == 0).</li>
<li>Check special handling for cases with A[i] == 0 and lambda[i] == 0 in parameter approximaton. Max analyzed it and concluded that checks are not necessary. My though: copy paste artifacts from the the w[i] == 0 check (which is wrong).</li>
<li>Show prarp in <code><a href="reference/plot_spectrum.html">plot_spectrum()</a></code>
</li>
<li>Show peak scores in <code><a href="reference/plot_spectrum.html">plot_spectrum()</a></code>
</li>
</ul></div>
</div>
</div>
<div class="section level1">
<h1 id="done">DONE<a class="anchor" aria-label="anchor" href="#done"></a></h1>
<div class="section level2">
<h2 id="check">CHECK<a class="anchor" aria-label="anchor" href="#check"></a></h2>
<div class="section level3">
<h3 id="check-1-use-of-dtypp-in-load_spectrum">CHECK-1: Use of DTYPP in load_spectrum<a class="anchor" aria-label="anchor" href="#check-1-use-of-dtypp-in-load_spectrum"></a></h3>
<p>In function <code>deconvolution</code> from <code>MetaboDecon1D_deconvolution.R:121</code> or the extracted version <code>read_1r_file</code>, the y values are read as follows:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">int_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"\\D+"</span>, <span class="st">""</span>, <span class="va">procs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/startsWith.html" class="external-link">startsWith</a></span><span class="op">(</span><span class="va">procs</span>, <span class="st">"##$DTYPP="</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">int_size</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">int_type</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="fl">4</span> <span class="kw">else</span> <span class="fl">8</span></span>
<span><span class="va">path_1r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">path</span>, <span class="va">expno</span>, <span class="st">"pdata"</span>, <span class="va">procno</span>, <span class="st">"1r"</span><span class="op">)</span></span>
<span><span class="va">spec_stream</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">file</a></span><span class="op">(</span><span class="va">path_1r</span>, <span class="st">"rb"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">close</a></span><span class="op">(</span><span class="va">spec_stream</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readBin.html" class="external-link">readBin</a></span><span class="op">(</span></span>
<span>   <span class="va">spec_stream</span>,</span>
<span>   what <span class="op">=</span> <span class="st">"int"</span>,</span>
<span>   size <span class="op">=</span> <span class="va">int_size</span>,</span>
<span>   n <span class="op">=</span> <span class="va">n</span>,</span>
<span>   signed <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>   endian <span class="op">=</span> <span class="st">"little"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>But in <a href="http://www.nmragenda-leiden.nl/static/Bruker_manual_4.1.4/topspin_pdf/Bruker_NMR_Data_Formats.pdf" class="external-link">Bruker_NMR_Data_Formats.pdf</a> it says:</p>
<blockquote>
<p>The processing status parameter <code>DTYPP</code> defines how the data values are stored. If the <code>DTYPP</code> is 0 (“int”), the stored value represents a mantissa of the data point value, the processing status parameter <code>NC_proc</code> is the exponent. In this case all data points share the same exponent.</p>
<p>[…]</p>
<p>Their format is given by the parameter <code>DTYPP</code>, the byte ordering is given by the parameter <code>BYTORDP</code>, both may be read from the processing status parameter file <code>procs</code>.</p>
</blockquote>
<p>e.i., we should read y as</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path_1r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">path</span>, <span class="va">expno</span>, <span class="st">"pdata"</span>, <span class="va">procno</span>, <span class="st">"1r"</span><span class="op">)</span></span>
<span><span class="va">spec_stream</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">file</a></span><span class="op">(</span><span class="va">path_1r</span>, <span class="st">"rb"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">close</a></span><span class="op">(</span><span class="va">spec_stream</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">dtypp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"\\D+"</span>, <span class="st">""</span>, <span class="va">procs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/startsWith.html" class="external-link">startsWith</a></span><span class="op">(</span><span class="va">procs</span>, <span class="st">"##$DTYPP="</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ncproc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">procs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/startsWith.html" class="external-link">startsWith</a></span><span class="op">(</span><span class="va">procs</span>, <span class="st">"##$NC_proc="</span><span class="op">)</span><span class="op">]</span>, <span class="st">"="</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">bytordp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">procs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/startsWith.html" class="external-link">startsWith</a></span><span class="op">(</span><span class="va">procs</span>, <span class="st">"##$BYTORDP"</span><span class="op">)</span><span class="op">]</span>, <span class="st">"="</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">dtypp</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>   <span class="va">mantissa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readBin.html" class="external-link">readBin</a></span><span class="op">(</span></span>
<span>      <span class="va">spec_stream</span>,</span>
<span>      what <span class="op">=</span> <span class="st">"int"</span>,</span>
<span>      size <span class="op">=</span> <span class="fl">4</span>,</span>
<span>      n <span class="op">=</span> <span class="va">n</span>,</span>
<span>      endian <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">bytordp</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="st">"little"</span> <span class="kw">else</span> <span class="st">"big"</span>,</span>
<span>      signed <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># this needs to be verified as well</span></span>
<span>   <span class="op">)</span></span>
<span>   <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">mantissa</span> <span class="op">*</span> <span class="op">(</span><span class="fl">2</span> <span class="op">^</span> <span class="va">ncproc</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>   <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Not yet implemented"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Note: I’ve checked the <a href="misc/example_datasets/bruker/urine/urine_1/10/pdata/10/1r">urine/urine_1/10/pdata/10/1r</a> example file. There we have <code>ncproc == -2</code>, i.e. using the above described implementation, we would get <code>y &lt;- mantissa * (2 ^ (-2))</code> == <code>y &lt;- mantissa * 0.25</code>, i.e. the right now the values we use are 4 times larger as they should be. I guess that’s not the end of the world, as signals get scaled anyway.</p>
<p>Further useful info from <a href="http://www.nmragenda-leiden.nl/static/Bruker_manual_4.1.4/topspin_pdf/Bruker_NMR_Data_Formats.pdf" class="external-link">Bruker_NMR_Data_Formats.pdf</a>:</p>
<blockquote>
<p>The raw data files <code>fid</code> and <code>ser</code> contain one dimensional or multi-dimensional acquired data, respectively. They consist of a sequence of acquired data point values in binary format. The acquisition status parameter <code>DTYPA</code> defines, how the data values are stored. If the <code>DTYPA</code> is “int” the stored value represents a mantissa of the data point value, the acquisition parameter NC is the exponent. All data points share in this case the same exponent. If <code>DTYPA</code> is “double”, the data points are stored as a double precision 64 bit floating number, parameter NC is not used.</p>
</blockquote>
<p>Note: there are also images in <em>Bruker_NMR_Data_Formats.pdf</em> explaining how to interpret 64 bit float numbers.</p>
<hr><p>2024/06/28: Checked and now traced by issue <a href="#feature-9-implement-and-export-read_spectra">FEATURE-9</a>.</p>
</div>
<div class="section level3">
<h3 id="check-2-signal-free-region-sfr-calculation">CHECK-2: Signal free region (SFR) calculation<a class="anchor" aria-label="anchor" href="#check-2-signal-free-region-sfr-calculation"></a></h3>
<p>In function <code>deconvolution</code> of file <a href="R/MetaboDecon1D.R#1372">MetaboDecon1D.R</a>, the signal free region border in data points is calculated as follows:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate signal free region</span></span>
<span><span class="va">signal_free_region_left</span>  <span class="op">&lt;-</span> <span class="op">(</span><span class="va">spectrum_length</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">-</span><span class="op">(</span><span class="op">(</span><span class="va">ppm_highest_value</span><span class="op">-</span><span class="va">signal_free_region</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">ppm_range</span><span class="op">/</span><span class="va">spectrum_length</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">signal_free_region_right</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">spectrum_length</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">-</span><span class="op">(</span><span class="op">(</span><span class="va">ppm_highest_value</span><span class="op">-</span><span class="va">signal_free_region</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">ppm_range</span><span class="op">/</span><span class="va">spectrum_length</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>These versions contain the following two errors:</p>
<ul><li>Error 1: <code>spectrum$ppm_nstep</code> is used instead of <code>spectrum$ppm_step</code>. That’s not really important, because it only causes a slight shift of the border towards the max value, but the number of data points to the left (or right) of the border stays the same (except for the edge case where the border falls exactly on a datapoint).</li>
<li>Error 2: The <code>+ 1</code> in <code>(spectrum$n + 1)</code> is wrong. It should be <code>- 1</code>. This causes the signal free border to be shifted two points to the left.</li>
</ul><p>Example code to demonstrate the error:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dp</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>,   <span class="fl">6</span>,   <span class="fl">5</span>,   <span class="fl">4</span>,   <span class="fl">3</span>,    <span class="fl">2</span>,    <span class="fl">1</span>,    <span class="fl">0</span>   <span class="op">)</span></span>
<span><span class="va">ppm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4.7</span>, <span class="fl">3.4</span>, <span class="fl">2.1</span>, <span class="fl">0.8</span>, <span class="op">-</span><span class="fl">0.5</span>, <span class="op">-</span><span class="fl">1.8</span>, <span class="op">-</span><span class="fl">3.1</span>, <span class="op">-</span><span class="fl">4.4</span><span class="op">)</span></span>
<span><span class="va">sfrl_ppm</span> <span class="op">&lt;-</span> <span class="fl">2.0</span> <span class="co"># i.e. 3 points left</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dp</span><span class="op">)</span> <span class="co"># 8 (n) data points, i.e. 7 (n - 1) intervals of size 1.3 in between</span></span>
<span><span class="va">ppm_step</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ppm</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">ppm</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># 1.3</span></span>
<span><span class="va">ppm_nstep</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ppm</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">ppm</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">n</span> <span class="co"># 1.11</span></span>
<span><span class="va">sfrl_dp</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">n</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ppm</span><span class="op">)</span> <span class="op">-</span> <span class="va">sfrl_ppm</span><span class="op">)</span> <span class="op">/</span> <span class="va">ppm_nstep</span></span>
<span><span class="co"># 8 - (4.7 - 2.0) / 1.11  ==  8 - 2.37  ==  6.63  ==&gt; 1 point left</span></span>
<span><span class="va">sfrl_dp_without_error_1</span> <span class="op">&lt;-</span> <span class="va">sfrl_dp</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">n</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ppm</span><span class="op">)</span> <span class="op">-</span> <span class="va">sfrl_ppm</span><span class="op">)</span> <span class="op">/</span> <span class="va">ppm_step</span></span>
<span><span class="co"># 8 - (4.7 - 2.0) / 1.3  ==  8 - 2.08  ==  6.92  ==&gt; 1 point left</span></span>
<span><span class="va">sfrl_dp_correct</span> <span class="op">&lt;-</span> <span class="va">sfrl_dp</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ppm</span><span class="op">)</span> <span class="op">-</span> <span class="va">sfrl_ppm</span><span class="op">)</span> <span class="op">/</span> <span class="va">ppm_step</span></span>
<span><span class="co"># 6 - (4.7 - 2.0) / 1.3  ==  6 - 2.08  ==  4.92  ==&gt; 3 point left</span></span></code></pre></div>
<p>It’s not a big deal as we have over 100000 data points in our examples and whether we exclude e.g. 20500 or 20502 is not super important, as the user cannot make such a precise estimate anyways based on the shown plot, but it makes the code really confusing to understand.</p>
<p>The correct method of converting ppm to dp is <code>(sfrl_ppm - min(ppm)) / ppm_step</code> as done in function <code>ppm_to_dp</code> in <code>00_util.R</code>.</p>
<hr><p>Closed with v1.2 because we have a correct implementation in <code>ppm_to_dp</code> in <code>00_util.R</code>. However, in <code><a href="reference/deconvolute.html">generate_lorentz_curves()</a></code> we will continue to use the wrong calculation to stay backwards compatible. The new method will be used in the successor function <code>deconvolute_spectra()</code>, tracked by <a href="#feature-10-implement-deconvolute_spectra">FEATURE-10</a></p>
</div>
<div class="section level3">
<h3 id="check-3-water-signal-calculation">CHECK-3: Water signal calculation<a class="anchor" aria-label="anchor" href="#check-3-water-signal-calculation"></a></h3>
<p>In function <code>deconvolution</code> of file <a href="R/MetaboDecon1D_deconvolution.R#443">MetaboDecon1D_deconvolution.R</a>, the water signal border in data points is calculated as follows:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Remove water signal</span></span>
<span><span class="va">water_signal_position</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">spectrum_x</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span></span>
<span><span class="va">water_signal_position_ppm</span> <span class="op">&lt;-</span> <span class="va">spectrum_x_ppm</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">spectrum_x_ppm</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="co"># Recalculate ppm into data points</span></span>
<span><span class="va">range_water_signal</span><span class="op">&lt;-</span> <span class="va">range_water_signal_ppm</span><span class="op">/</span><span class="op">(</span><span class="va">ppm_range</span><span class="op">/</span><span class="va">spectrum_length</span><span class="op">)</span></span>
<span><span class="va">water_signal_left</span> <span class="op">&lt;-</span> <span class="va">water_signal_position</span> <span class="op">-</span> <span class="va">range_water_signal</span></span>
<span><span class="va">water_signal_right</span> <span class="op">&lt;-</span> <span class="va">water_signal_position</span> <span class="op">+</span> <span class="va">range_water_signal</span></span></code></pre></div>
<p>This is wrong, because of the following two reasons:</p>
<ol style="list-style-type: decimal"><li>We count datapoints from 0 to (n - 1), i.e. taking <code>length(spectrum_x)/2</code> is incorrect. It should be <code>(length(spectrum_x) - 1)/2</code> instead. The reason can be easily seen in the example code below.</li>
<li>Taking <code>spectrum_x_ppm[length(spectrum_x_ppm)/2]</code> as middle ppm value only works, if <code>length(spectrum_x_ppm)/2</code> is an integer, i.e. in case of an even number of data points. As soon as we have an odd number of data points <code>length(spectrum_x_ppm)/2</code> will be a float. E.g. for 5 data points, it will be 2.5 and calling <code>spectrum_x_ppm[2.5]</code> will give the wrong result.</li>
</ol><p>Example code</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dp</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>,   <span class="fl">5</span>,   <span class="fl">4</span>,   <span class="fl">3</span>,    <span class="fl">2</span>,    <span class="fl">1</span>,    <span class="fl">0</span>  <span class="op">)</span> <span class="co"># median and mean is 3</span></span>
<span><span class="va">ppm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4.7</span>, <span class="fl">3.4</span>, <span class="fl">2.1</span>, <span class="fl">0.8</span>, <span class="op">-</span><span class="fl">0.5</span>, <span class="op">-</span><span class="fl">1.8</span>, <span class="op">-</span><span class="fl">3.1</span><span class="op">)</span> <span class="co"># median and mean is 0.8</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dp</span><span class="op">)</span> <span class="co"># 7</span></span>
<span></span>
<span><span class="co"># Current wrong code</span></span>
<span><span class="va">ws_dp</span> <span class="op">&lt;-</span> <span class="va">n</span><span class="op">/</span><span class="fl">2</span> <span class="co"># 3.5</span></span>
<span><span class="va">ws_ppm</span> <span class="op">&lt;-</span> <span class="va">ppm</span><span class="op">[</span><span class="va">ws_dp</span><span class="op">]</span> <span class="co"># error</span></span>
<span></span>
<span><span class="co"># Correct code</span></span>
<span><span class="va">ws_dp</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span> <span class="co"># 3</span></span>
<span><span class="va">ws_ppm</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ppm</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">ppm</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span> <span class="co"># 0.8 and also works for odd ((n - 1) / 2)</span></span></code></pre></div>
<blockquote>
<p>[!IMPORTANT] Check result: Will be fixed with function <code>deconvolute_spectra</code> in <a href="#check-10-negative-values-for-estimated-a">FEATURE-10</a>.</p>
</blockquote>
</div>
<div class="section level3">
<h3 id="check-4-data-point-format">CHECK-4: Data point format<a class="anchor" aria-label="anchor" href="#check-4-data-point-format"></a></h3>
<ol style="list-style-type: decimal"><li>Why do we count data points starting from 0 instead of 1? That makes programming in R complicated, as R starts counting at 1.</li>
<li>Why do we use “scaled data points” as x values? That’s unintuitive and (as far as I can see) unnecessary.</li>
<li>Why do we show large ppm values left and low values right?</li>
</ol><blockquote>
<p>[!IMPORTANT] Check result: Discussion with Wolfram lead to the following conclusions:</p>
<ol style="list-style-type: decimal"><li>Reason why MetaboDecon starts counting at 0 is not clear. Probably because Martina has C or python background and was more comfortable with 0-based indexing. For <code>generate_lorentz_curves</code> we will keep the 0-based indexing to stay backwards compatible. For <code>deconvolute_spectra</code> we will switch to 1-based indexing. Tracked by <a href="#feature-10-implement-deconvolute_spectra">FEATURE-10</a>.</li>
<li>Intention was to prevent rounding errors, but as far as I can see that’s not necessary. For <code>deconvolute_spectra</code> we completely remove the scale factor and scaled data point numbers. Tracked by <a href="#feature-10-implement-deconvolute_spectra">FEATURE-10</a>.</li>
<li>That’s the general convention in NMR spectroscopy and stems from the fact that in the early days of NMR the frequency was kept contant and the magnetic field was changed instead. To keep the way the spectra looked like, the frequency had to be shown from high to low values. We will keep this convention.</li>
</ol></blockquote>
</div>
<div class="section level3">
<h3 id="check-5-signal-preprocessing">CHECK-5: Signal preprocessing<a class="anchor" aria-label="anchor" href="#check-5-signal-preprocessing"></a></h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Remove water signal</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">ws</span><span class="op">$</span><span class="va">right_dp</span><span class="op">:</span><span class="va">ws</span><span class="op">$</span><span class="va">left_dp</span><span class="op">)</span> <span class="op">{</span></span>
<span>   <span class="va">spectrum</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.00000001</span> <span class="co"># &lt;--- why not zero or min(spectrum$y)?</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Remove negative values of spectrum by Saving the absolut values</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">spectrum</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>   <span class="va">spectrum</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">spectrum</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="co"># # &lt;--- why abs instead of zero or min(spectrum$y)?</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>ToSc:</p>
<ul><li>WS: check if other zeros. If no, use <code>min(spectrum$y)</code>.</li>
<li>Negatives: leave as is</li>
</ul></div>
<div class="section level3">
<h3 id="check-6-negative-value-removal">CHECK-6: Negative value removal<a class="anchor" aria-label="anchor" href="#check-6-negative-value-removal"></a></h3>
<p>Why do we “remove negative values” using <code>abs</code> instead of setting them to zero or the minimum value of the spectrum? See <a href="R/MetaboDecon1D.R#1781">R/MetaboDecon1D.R#1781</a></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Remove negative values of spectrum by Saving the absolut values</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">spectrum_y</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>   <span class="va">spectrum_y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">spectrum_y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<blockquote>
<p>[!IMPORTANT] Check result: Discussed with Wolfram and decided that it doesn’t matter whether we use <code>abs</code> for negative removal or something else, as these signals should be filtered out anyways by the algorithm.</p>
</blockquote>
</div>
<div class="section level3">
<h3 id="check-7-peak-selection-procedure">CHECK-7: Peak selection procedure<a class="anchor" aria-label="anchor" href="#check-7-peak-selection-procedure"></a></h3>
<p>Currently the <a href="(R/MetaboDecon1D.R#1825)">peak selection procedure</a></p>
<ol style="list-style-type: decimal"><li>Requires two loops in R, which is low</li>
<li>Iterates from 1:(m-2) instead of 2:(m-1), which is wrong and might cause the miss of one peak if it’s at the very end of the spectrum (which is almost certainly in the signal free region so it’s not too bad).</li>
</ol><p>We should use vectorized operations and correct indexing to fix this.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Peak selection procedure</span></span>
<span></span>
<span><span class="co"># Calculate second derivative of spectrum</span></span>
<span><span class="va">second_derivative</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">2</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">spectrum_x</span><span class="op">)</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">spectrum_x</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>   <span class="va">second_derivative</span><span class="op">[</span><span class="fl">1</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">spectrum_x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>   <span class="va">second_derivative</span><span class="op">[</span><span class="fl">2</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">spectrum_y</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">spectrum_y</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span><span class="fl">2</span><span class="op">*</span><span class="va">spectrum_y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Find all local minima of second derivative</span></span>
<span><span class="va">peaks_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">peaks_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">second_derivative_border</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">second_derivative</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">second_derivative_border</span><span class="op">)</span><span class="op">{</span></span>
<span>   <span class="kw">if</span><span class="op">(</span><span class="va">second_derivative</span><span class="op">[</span><span class="fl">2</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>   <span class="kw">if</span><span class="op">(</span><span class="op">(</span><span class="va">second_derivative</span><span class="op">[</span><span class="fl">2</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;=</span> <span class="va">second_derivative</span><span class="op">[</span><span class="fl">2</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">second_derivative</span><span class="op">[</span><span class="fl">2</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">second_derivative</span><span class="op">[</span><span class="fl">2</span>,<span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="co">#if(((spectrum_y[i+1] &gt;= spectrum_y[i]) &amp; (spectrum_y[i+1] &gt; spectrum_y[i+2])) | ((spectrum_y[i+1] &gt; spectrum_y[i]) &amp; (spectrum_y[i+1] &gt;= spectrum_y[i+2]))){</span></span>
<span>      <span class="co"># Add local minima to peak list</span></span>
<span>      <span class="va">peaks_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">peaks_x</span>, <span class="va">second_derivative</span><span class="op">[</span><span class="fl">1</span>,<span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">peaks_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">peaks_index</span>, <span class="va">i</span><span class="op">)</span></span>
<span>   <span class="op">}</span></span>
<span>   <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<blockquote>
<p>[!IMPORTANT] Check result: Implemented in function <a href="R/generate_lorentz_curves.R#1325">select_peaks_v2</a>.</p>
</blockquote>
</div>
<div class="section level3">
<h3 id="check-8-fix-name-of-samples-in-blood-dataset">CHECK-8: Fix name of samples in blood dataset<a class="anchor" aria-label="anchor" href="#check-8-fix-name-of-samples-in-blood-dataset"></a></h3>
<p>It should be <code>Blood</code> not <code>Bood</code>.</p>
<blockquote>
<p>[!IMPORTANT] Check result: Fixed in branch <code>test-glc</code></p>
</blockquote>
</div>
<div class="section level3">
<h3 id="check-9-ask-wolfram-about-peak-selection">CHECK-9: Ask Wolfram about peak selection<a class="anchor" aria-label="anchor" href="#check-9-ask-wolfram-about-peak-selection"></a></h3>
<p>Ask Wolfram whether it’s ok that the peak selection sometimes selects two peaks for one local maximum.</p>
<blockquote>
<p>[!IMPORTANT] Check result: That’s ok and by intention.</p>
</blockquote>
</div>
</div>
<div class="section level2">
<h2 id="feature">FEATURE<a class="anchor" aria-label="anchor" href="#feature"></a></h2>
<div class="section level3">
<h3 id="feature-1-use-temp-dirs-for-example-data">FEATURE-1: Use temp dirs for example data<a class="anchor" aria-label="anchor" href="#feature-1-use-temp-dirs-for-example-data"></a></h3>
<p>Function <code>download_example_data</code> should allow users to specify a temp dir instead the usual XDG directory. This is useful to pass CRAN checks as CRAN doesn’t allow writing to th user’ home directory.</p>
<p><em>Done with <a href="https://github.com/spang-lab/metabodecon/tree/d65098cf869e8959055b16570b5d41b5a5c9b46b" class="external-link">1.1.0+d65098c</a>.</em></p>
</div>
<div class="section level3">
<h3 id="feature-2-add-minimal-example-dataset">FEATURE-2: Add minimal example dataset<a class="anchor" aria-label="anchor" href="#feature-2-add-minimal-example-dataset"></a></h3>
<p>Add a minimal dataset to the package, so that the user can run the examples without having to download the full example data. The minimal dataset should be smaller than 1MB. Idea: remove every second or third datapoint from two example spectra, this be enough to get below 1MB.</p>
<p><em>Canceled because with <a href="https://github.com/spang-lab/metabodecon/tree/d65098cf869e8959055b16570b5d41b5a5c9b46b" class="external-link">1.1.0+d65098c</a> we introduced caching for <code>download_example_data</code>, so there is no need for including the minimal dataset anymore.</em></p>
</div>
<div class="section level3">
<h3 id="feature-3-batch-mode">FEATURE-3: Batch Mode<a class="anchor" aria-label="anchor" href="#feature-3-batch-mode"></a></h3>
<p>We should have a batch mode, that does all the above steps truly automatically and creates a pdf containing all quality control images. The pdf can be inspected later on and based on the findings the function call can be adjusted.</p>
<ol style="list-style-type: decimal"><li><label><input type="checkbox" checked><strong>PR test-glc</strong>: Add test cases for <code>generate_lorentz_curves</code>. Just copy from test cases of <code>MetetaboDecon1D</code> and adjust a little bit.</label></li>
<li><label><input type="checkbox" checked><strong>PR batch-mode</strong>: Add test cases for <code>generate_lorentz_curves_v2</code>. Just copy from test cases of <code>generate_lorentz_curves</code> and fix <code>generate_lorentz_curves_v2</code> to pass these tests. (Now we have backwards compatibility)</label></li>
<li><label><input type="checkbox" checked><strong>PR batch-mode</strong>: Replace <code>generate_lorentz_curves</code> with <code>generate_lorentz_curves_v2</code></label></li>
<li><label><input type="checkbox" checked><strong>PR batch-mode</strong>: Add remaining arguments of <code>MetaboDecon1D</code> to <code>generate_lorentz_curves</code> and make sure the are passed on correctly</label></li>
<li><label><input type="checkbox" checked><strong>PR batch-mode</strong>: Add argument <code>ask</code> to <code>generate_lorentz_curves</code></label></li>
<li><label><input type="checkbox" checked><strong>PR batch-mode</strong>: Adjust <code>mock_readline</code> so that it throws an exception if called more often than there are answers</label></li>
<li><label><input type="checkbox" checked><strong>PR batch-mode</strong>: Implement the ask parameter in <code>generate_lorentz_curves</code> until all tests pass</label></li>
<li><label><input type="checkbox" checked><strong>PR clear-helpers</strong>: Remove helper functions that are not used anymore</label></li>
</ol></div>
<div class="section level3">
<h3 id="feature-4-parallelize">FEATURE-4: Parallelize<a class="anchor" aria-label="anchor" href="#feature-4-parallelize"></a></h3>
<p>Batch mode can also run in parallel to speed up calculations. Instead of waiting 1h we need to wait 3 or 6 minutes then.</p>
</div>
<div class="section level3">
<h3 id="feature-5-add-test-suite">FEATURE-5: Add test suite<a class="anchor" aria-label="anchor" href="#feature-5-add-test-suite"></a></h3>
<p>Write test cases for every function to ensure that future updates don’t break any existing behaviour. Tests should be run automatically upon pull requests and pushes to main.</p>
</div>
<div class="section level3">
<h3 id="feature-6-return-lambda-in-hertz">FEATURE-6: Return lambda in hertz<a class="anchor" aria-label="anchor" href="#feature-6-return-lambda-in-hertz"></a></h3>
<p>Original Teams Messages:</p>
<!-- /* cSpell:disable */ -->
<p>From Wolfram at <code>2023/11/08 3:29 PM</code></p>
<p><em>Hi Tobi, ich würde MetaboDecon gerne noch um ca zwei-drei Zeilen Code erweitern. wir geben für jedes Signal einen lambda Wert an, das ist die halbe Signalbreite auf halber Höhe. Dieser Wert wird in Datenpunkten angegeben. Für viele Anwendungen braucht man diesen Wert aber auch in Hertz d.h. ich würde auch die lamda Werte in Hertz angeben die Umwandlung ist ganz einfach.</em></p>
<p>From Wolfram at <code>2023/11/16 10:50 AM</code></p>
<p>Hi Tobi hier ist der Code zur Linienbreitenberechnung in Hz, Achtung ich hab hier immer die gesamte Linienbreite auf halber Höhe berechnet</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function to compute the linewidh for all detected features in Hz based on the original</span></span>
<span><span class="co"># values given in points</span></span>
<span><span class="co"># lw_hz = line width in Hz</span></span>
<span><span class="co"># sw_hz = spectral width in hz</span></span>
<span><span class="co"># dp datapoints</span></span>
<span><span class="va">return_path</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"C:/Users/Gronwald/Metabolomics/Statistics/Deconvolution/Rechnungen_wolfram/Alex_Ref_metabolites_in_Water/"</span><span class="op">)</span></span>
<span><span class="va">lw_hz</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">spectrum_data</span>, <span class="va">sw_hz</span><span class="op">)</span> <span class="op">{</span></span>
<span>   <span class="kw">for</span> <span class="op">(</span><span class="va">entry</span> <span class="kw">in</span> <span class="va">spectrum_data</span><span class="op">)</span></span>
<span>   <span class="op">{</span></span>
<span>      <span class="va">dp</span> <span class="op">&lt;-</span> <span class="va">entry</span><span class="op">$</span><span class="va">x_values</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="fl">1000</span> <span class="op">+</span> <span class="fl">1</span> <span class="co"># multipy  with 1000 (scale factor) and add 1 as last datapoint has index 0</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"dp="</span>, <span class="va">dp</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>      <span class="co"># multiply with 1000 (sale factor)</span></span>
<span>      <span class="co"># multiply with 2 to get full linewidth instead of half-linewidth</span></span>
<span>      <span class="co"># take abs as original lambda is given in negative values</span></span>
<span>      <span class="va">entry</span><span class="op">$</span><span class="va">lambda_hz</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="op">(</span><span class="va">sw_hz</span><span class="op">/</span><span class="va">dp</span><span class="op">)</span><span class="op">*</span><span class="va">entry</span><span class="op">$</span><span class="va">lambda</span><span class="op">*</span><span class="fl">1000</span><span class="op">*</span><span class="fl">2</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"lambda= "</span>,<span class="va">entry</span><span class="op">$</span><span class="va">lambda_hz</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>,<span class="st">"\n"</span><span class="op">)</span> <span class="co"># random signal to show that everything works</span></span>
<span>      <span class="va">entry</span><span class="op">$</span><span class="va">rl1</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">entry</span><span class="op">$</span><span class="va">peak_triplets_middle</span>,<span class="va">entry</span><span class="op">$</span><span class="va">lambda_hz</span><span class="op">)</span></span>
<span>      <span class="va">entry</span><span class="op">$</span><span class="va">rl2</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">entry</span><span class="op">$</span><span class="va">rl1</span>,<span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">entry</span><span class="op">$</span><span class="va">integrals</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">ret_nam</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">return_path</span>,<span class="va">entry</span><span class="op">$</span><span class="va">filename</span>,<span class="st">"_lw.csv"</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv2</a></span><span class="op">(</span><span class="va">entry</span><span class="op">$</span><span class="va">rl2</span>,file<span class="op">=</span><span class="va">ret_nam</span><span class="op">)</span></span>
<span>   <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>2024/07/09: Done in branch <code>v1.2.0</code> with commit <code>5a9ed6ab00d8e641a2aa82d209de6604d86bf9be</code>.</p>
</div>
<div class="section level3">
<h3 id="feature-7-improve-return-value">FEATURE-7: Improve return value<a class="anchor" aria-label="anchor" href="#feature-7-improve-return-value"></a></h3>
<p>The complete history of transformations, e.g. “removal of water signal”, “removal of negative values” or “smoothing” should be traceable from the return value of <code>generate_lorentz_curves</code>. Therefore I propose the following changes to the return value of <code>generate_lorentz_curves</code>:</p>
<ul><li>
<code>urine_1</code>
<ul><li>
<code>number_of_files</code> –&gt; length of list</li>
<li>
<code>filename</code> –&gt; <code>path</code>
</li>
<li>
<code>x_values</code> –&gt; remove (Currently this is given in “scaled data points”, which is a strange unit)</li>
<li>
<code>x_values_ppm</code> –&gt; <code>ppm</code>
</li>
<li>
<code>y_values</code> –&gt; <code>si</code>
</li>
<li>
<code>spectrum_superposition</code> –&gt; ??</li>
<li>
<code>mse_normed</code> –&gt; <code>mse</code>
</li>
<li>
<code>index_peak_triplets_middle</code> –&gt; <code>peaks$middle</code>
</li>
<li>
<code>index_peak_triplets_left</code> –&gt; <code>peaks$left</code>
</li>
<li>
<code>index_peak_triplets_right</code> –&gt; <code>peaks$right</code>
</li>
<li>
<code>peak_triplets_middle</code> –&gt; remove (see REFACTOR-6 “Single source of Truth”)</li>
<li>
<code>peak_triplets_left</code> –&gt; remove (see REFACTOR-6 “Single source of Truth”)</li>
<li>
<code>peak_triplets_right</code> –&gt; remove (see REFACTOR-6 “Single source of Truth”)</li>
<li>
<code>integrals</code> –&gt; ??</li>
<li>
<code>signal_free_region</code> –&gt; <code>sfr</code>
</li>
<li>
<code>range_water_signal_ppm</code> –&gt; <code>ws</code>
</li>
<li>
<code>A</code> –&gt; ??</li>
<li>
<code>lambda</code> –&gt; ??</li>
<li>
<code>x_0</code> –&gt; ??</li>
</ul></li>
</ul><p>For the “??”” values I haven’t yet checked how they’re calculated, so I cannot really say whether or how they could be named. But for the others, the improved return value could look like this:</p>
<ul><li>
<code>urine_1</code>
<ul><li>
<code>ppm</code> (parts per million for each data point)</li>
<li>
<code>si</code> (signal intensity)
<ul><li>
<code>raw</code> (raw)</li>
<li>
<code>wows</code> (without water signal)</li>
<li>
<code>wows_woneg</code> (without water signal and negative values)</li>
<li>
<code>wows_woneg_smoothed</code> (without water signal, negative values and smoothed)</li>
</ul></li>
<li>
<code>mse</code> (mean squared error)</li>
<li>
<code>peak</code> (peak triplet indices)
<ul><li>
<code>left</code> (index of left data point)</li>
<li>
<code>center</code> (index of middle data point)</li>
<li>
<code>right</code> (index of right data point)</li>
</ul></li>
<li>
<code>sfr</code> (signal free region in ppm)
<ul><li>
<code>left</code> (left border)</li>
<li>
<code>right</code> (right border)</li>
</ul></li>
<li>
<code>wshw</code> (water signal half width in ppm)</li>
<li>
<code>path</code> (absolute path to urine_1)</li>
</ul></li>
<li>
<code>urine_2</code>
<ul><li>…</li>
</ul></li>
</ul><p>2024/06/28: Closed without implementation, as we will keep the return value of <code>generate_lorentz_curves</code> backwards compatible with <code>MetabDecon1D</code> and instead fix it in <code>deconvolute_spectra</code>.</p>
</div>
<div class="section level3">
<h3 id="feature-9-implement-read_spectra">FEATURE-9 Implement read_spectra<a class="anchor" aria-label="anchor" href="#feature-9-implement-read_spectra"></a></h3>
<p>Implement and export <code>read_spectra</code> and <code>read_spectrum</code> in a way that</p>
<ol style="list-style-type: decimal"><li>DTYPP is interpreted correctly (see <a href="#check-1-use-of-dtypp-in-load_spectrum">CHECK-1</a>) and</li>
<li>The spectrum width (SW) in Hz as well as the Magnetic Field Strength is returned (see <a href="#feature-6-return-lambda-in-hertz">FEATURE-6</a>).</li>
</ol><p>This function can then be used to read spectra if a character string is provided as argument to <code>deconvolute_spectra()</code> or <code>generate_lorentz_curves</code> (see <a href="#feature-11-accept-dataframes-in-glc">FEATURE-11</a>).</p>
<p>2024/07/03: done in branch <code>v1.2.0</code> with commit <code>e3c35dce9965cf9a3a44383be818a8f5ab1b0c6e</code>. Note: the Magnetic Field Strength is not returned directly, but can be calculated via function <code>calc_B()</code>.</p>
</div>
<div class="section level3">
<h3 id="feature-11-accept-dataframes-in-glc">FEATURE-11: Accept dataframes in GLC<a class="anchor" aria-label="anchor" href="#feature-11-accept-dataframes-in-glc"></a></h3>
<p>Let <code>generate_lorentz_curves</code> accept dataframes as input. This is useful for Maximilians Bachelorthesis and also makes testing easier. If necessary, implement a private wrapper around <code>read_spectra</code>, called <code>read_spectra_glc</code> that converts the return value of <code>read_spectra</code> to a format that can be used by <code>deconvolute_spectra</code>.</p>
<p>2024/07/15: done in branch <code>v1.2.0</code> with commit <code>fa3c427cc1680925c6a12a0eab17f14673c6ee0f</code>.</p>
</div>
<div class="section level3">
<h3 id="feature-14-provide-simulated-datasets">FEATURE-14: Provide simulated datasets<a class="anchor" aria-label="anchor" href="#feature-14-provide-simulated-datasets"></a></h3>
<p>Provide simulated datasets from blood spectra</p>
<p>2024/17/15: Done in branch <code>v1.2.0</code> with commit <code>d01706c1f5885b6e965b55c6db53c041c866ed47</code></p>
</div>
<div class="section level3">
<h3 id="feature-15-add-lifecycle-badges">FEATURE-15: Add lifecycle badges<a class="anchor" aria-label="anchor" href="#feature-15-add-lifecycle-badges"></a></h3>
<p>Add lifecycle badges to all non-stable exported functions. Functions which are exported but should not be used should be marked as “experimental” or (if possible) as “internal” (idea: check where other badges are stored and whether they can be modified).</p>
<p>2024/07/15: Closed. Will be done with <a href="#doc-1-document-whole-package">DOC-1: Document whole package</a>.</p>
</div>
<div class="section level3">
<h3 id="feature-17-discard-output">FEATURE-17: Discard output<a class="anchor" aria-label="anchor" href="#feature-17-discard-output"></a></h3>
<p>By default output of <code>generate_lorentz_curves</code> should be discarded during parallel phase. Before this phase, print a message that the remaining task might take up to a few minutes and that live output can be disabled by settings <code>share_stdout = TRUE</code>, but that the output might be scrambled depending on configuration of the R installation and the operating system.</p>
<p>2024/07/09: Done in branch <code>v1.2.0</code> with commit <code>f9bf57a5e4c7167dfc3231cfe0ee515b40ad12bf</code>.</p>
</div>
<div class="section level3">
<h3 id="feature-20-implement-deconvolute_blood">FEATURE-20: Implement deconvolute_blood<a class="anchor" aria-label="anchor" href="#feature-20-implement-deconvolute_blood"></a></h3>
<p>Implement function <code>deconvolute_blood()</code> which should roughly do the following</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">deconvolute_blood</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">cache</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">force</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>   <span class="va">rds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu">cachedir</span><span class="op">(</span><span class="op">)</span>, <span class="st">"deconvolute_blood.rds"</span><span class="op">)</span></span>
<span>   <span class="va">new</span> <span class="op">&lt;-</span> <span class="va">old</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">rds</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">rds</span><span class="op">)</span> <span class="kw">else</span> <span class="cn">NULL</span></span>
<span>   <span class="kw">if</span> <span class="op">(</span><span class="va">cache</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">old</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/download_example_datasets.html">download_example_datasets</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>      <span class="va">new</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/deconvolute.html">deconvolute</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span></span>
<span>   <span class="op">}</span></span>
<span>   <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">new</span>, <span class="va">old</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">old</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"Cache and deconvolution differ."</span>, immediate. <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>   <span class="op">}</span></span>
<span>   <span class="kw">if</span> <span class="op">(</span><span class="va">cache</span> <span class="op">&amp;&amp;</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">old</span><span class="op">)</span> <span class="op">||</span> <span class="va">force</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">logf</span><span class="op">(</span><span class="st">"Writing results to cache file %s"</span>, <span class="va">rds</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">new</span>, <span class="va">rds</span><span class="op">)</span></span>
<span>   <span class="op">}</span></span>
<span>   <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">new</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><em>2024-10-01 20:21: Done in branch v1.2.0 with commit 9b7d65d</em></p>
</div>
<div class="section level3">
<h3 id="feature-16-improve-multiprocessing">FEATURE-16: Improve multiprocessing<a class="anchor" aria-label="anchor" href="#feature-16-improve-multiprocessing"></a></h3>
<p>Right now, output gets scrambled because all procs share one stdout. We can fix this by not using parLapply, but distributing the tasks ourselver over the cores and in a mainloop collecting outputs and results.</p>
<p><em>Done in branch v1.2 with commit bea9348 at Thu Sep 12 17:14:20 2024 +0200</em></p>
</div>
<div class="section level3">
<h3 id="feature-18-implement-plot_spectrum">FEATURE-18: Implement plot_spectrum<a class="anchor" aria-label="anchor" href="#feature-18-implement-plot_spectrum"></a></h3>
<p>Implement <code>plot_spectrum</code> which should be the successor of the following functions:</p>
<ul><li>plot_triplets</li>
<li>plot_lorentz_curves_save_as_png</li>
<li>plot_spectrum_superposition_save_as_png</li>
</ul><p>All the functionality, i.e.</p>
<ul><li>showing triplets</li>
<li>showing individual lorentz curves and</li>
<li>showing superposition of all lorentz curves</li>
<li>storing plots as png on disk</li>
</ul><p>should be controllable via function arguments.</p>
<p><em>2024-12-11: Done in branch v1.2.0 with commit 44f8f02</em></p>
</div>
</div>
<div class="section level2">
<h2 id="refactor">REFACTOR<a class="anchor" aria-label="anchor" href="#refactor"></a></h2>
<div class="section level3">
<h3 id="refactor-1-combine-load_xxx_spectrum-functions">REFACTOR-1: Combine load_xxx_spectrum functions<a class="anchor" aria-label="anchor" href="#refactor-1-combine-load_xxx_spectrum-functions"></a></h3>
<p>Combine <code>load_jcampdx_spectrum</code> and <code>load_bruker_spectrum</code> into one function, which calls <code>read_jcampdx</code> or <code>read_bruker</code> depending on the <code>type</code> argument. The <code>read_*_spectrum</code> function should return the measured signal strengths as vector <code>y_ss</code> and the corresponding ppm values as vector <code>x_ppm</code>. All other elements returned by the <code>load_*_spectrum</code> functions can be calculated from those. This makes the code more maintainable and easier to understand.</p>
<p>Useful info for reading bruker files: according to <code>Bruker_NMR_Data_Formats.pdf</code> (available through Google), the text files <code>acqu?</code> and <code>proc?</code> contain acquisition and processing parameters. Files ending with <code>s</code> (<code>acqus</code>, <code>proc2s</code>, …) describe the status of the dataset. Other files (<code>acqu</code>, <code>proc2</code>, …) contain parameter values used in later processing or acquisition steps. Format of all parameter files corresponds to the JCAMP-DX standard, which allows the inclusion of vendor specific parameters by prefixing them with the character sequence <code>##$</code>. For this reason, all TopSpin parameters in the file are preceded by this sequence.</p>
</div>
<div class="section level3">
<h3 id="refactor-2-text-output--license-timestamps">REFACTOR-2: Text Output (-License, +Timestamps)<a class="anchor" aria-label="anchor" href="#refactor-2-text-output--license-timestamps"></a></h3>
<p>The output should be improved. The License should not be printed after every function execution, unless there is a strong reason to do so. Timestamps should be added to the output, so the user automatically has a rough idea how long the function will take to finish.</p>
</div>
<div class="section level3">
<h3 id="refactor-4-plotting-speed">REFACTOR-4: Plotting speed<a class="anchor" aria-label="anchor" href="#refactor-4-plotting-speed"></a></h3>
<p>Function <code>plot_lorentz_curves_save_as_png</code> is suuuuper slow. We should try to make this quicker.</p>
<p>2024/06/28: Closed without implementation, as the function was never exported and is now also properly marked with <code>noRd</code>.</p>
</div>
<div class="section level3">
<h3 id="refactor-5-speedup-smoothing">REFACTOR-5: Speedup smoothing<a class="anchor" aria-label="anchor" href="#refactor-5-speedup-smoothing"></a></h3>
<p>Currently, <a href="R/MetaboDecon1D.R#1797">smoothing of the spectra</a> is done in a for-loop in R, which is slow. We can speed this up by using the <code>filter</code> function, which is implemented in C and therefore much faster.</p>
<p>Implemented in function <code>smooth_signals_v2</code> in file <a href="R/generate_lorentz_curves.R">generate_lorentz_curves.R</a>. Unfortunately, results are slight different, due to numeric differences between the two methods, ie.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s1</span> <span class="op">&lt;-</span> <span class="fu">smooth_signals_v1</span><span class="op">(</span><span class="va">spec</span><span class="op">)</span></span>
<span><span class="va">s2</span> <span class="op">&lt;-</span> <span class="fu">smooth_signals_v2</span><span class="op">(</span><span class="va">spec</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">s1</span>, <span class="va">s2</span><span class="op">)</span> <span class="op">==</span> <span class="cn">FALSE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">s1</span>, <span class="va">s2</span><span class="op">)</span> <span class="op">==</span> <span class="cn">TRUE</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="refactor-6-use-a-single-unit-as-source-of-truth">REFACTOR-6: Use a single unit as source of truth<a class="anchor" aria-label="anchor" href="#refactor-6-use-a-single-unit-as-source-of-truth"></a></h3>
<p>Function <code>generate_lorentz_curves</code> and <code>MetaboDecon1D</code> use different units for their calculations and in their returned list, e.g. <code>ppm</code> (parts per million), <code>dp</code> (data points) and <code>sdp</code> (scaled data points) as x values and <code>si</code> (signal intensity), <code>ssi</code> (scaled signal intensity) as y values. Thats not good, as each conversion introduces numeric rounding errors and whenever we do a transformation, e.g. “removal of water signal”, “removal of negative values” or “smoothing”, we need to do the transformation for all units. Instead, we should use only one unit as single source of truth and provide conversion functions for the user, e.g. <code>ppm_to_hz</code> or <code>ppm_to_dp</code>. In the final returned list, it’s ok to have all units, but at least during the calculation we should stick to <code>ppm</code> and <code>si</code> I think.</p>
<p>This also makes input for the user much easier, because something like the following wouldn’t occur: in function <a href="R/MetaboDecon1D.R#1245">deconvolution</a> the argument <code>signal_free_region</code> is interpreted as <code>ppm</code> if <code>isFALSE(same_parameter) || current_filenumber == 1</code>. Else, the argument <code>signal_free_region</code> is interpreted as <code>sdp</code>. This is confusing and error prone.</p>
<p>2024/06/30: Tracked by <a href="#feature-10-implement-deconvolute_spectra">FEATURE-10</a> instead.</p>
</div>
<div class="section level3">
<h3 id="refactor-7-split-monolithic-functions-into-smaller-parts">REFACTOR-7: Split monolithic functions into smaller parts<a class="anchor" aria-label="anchor" href="#refactor-7-split-monolithic-functions-into-smaller-parts"></a></h3>
<p>The original <code>MetaboDecon1D</code> function has approx. 350 lines of code and the original <code>deconvolution</code> function has approx 1000 lines of code. This is way too much for testing and modifying. We should extract copy-pasted parts into indivual functions and test these functions separately.</p>
<p>2024/06/30: Done in function <code>generate_lorentz_curves</code> in branch <code>v1.2.0</code>.</p>
</div>
<div class="section level3">
<h3 id="refactor-8-improve-docs-for-metabodecon1d-return-value">REFACTOR-8: Improve docs for Metabodecon1D return value<a class="anchor" aria-label="anchor" href="#refactor-8-improve-docs-for-metabodecon1d-return-value"></a></h3>
<p>Original Teams Message from Wolfram from <code>2023/11/08 3:29 PM</code></p>
<!-- /* cSpell:disable */ -->
<p><em>Hi Tobi, es kommen ja in letzter Zeit eine ganze Menge Fragen zu MetaboDecon auch nach den Variablen im Output. Ich hab hier eine Zusammenstellung dieser Variablen gemacht, vielleicht können wir das auch noch einbauen? Viele Grüße Wolfram</em> <!-- /* cSpell:enable */ --></p>
<p>Output variables of MetaboDecon1D (These variables will be obtained for each analyzed spectrum):</p>
<ul><li>
<strong>Number_of_files:</strong> number of analyzed spectra (In case folder contains more than one spectrum value &gt;1).</li>
<li>
<strong>Filename:</strong> name of analyzed spectrum</li>
<li>
<strong>X_values:</strong> all data points of original spectrum are numbered in descending order. The first data point has the maximum value and the last one the value 0. If we have for example 131072 (128k) datapoints, the first has the value 131.071. Note that numbers were divided by the scale factor which has a default value of 1000 for the x_axis.</li>
<li>
<strong>X_values_ppm:</strong> as above but here the corresponding ppm values are provided.</li>
<li>
<strong>Y_values:</strong> intensities of original datapoints</li>
<li>
<strong>Spectrum_superposition:</strong> y-values of the superposition of all estimated Lorentzcurves, values are provided in a point-wise manner.</li>
<li>
<strong>Mse_normed:</strong> final mean-squared-error after optimization of all Lorentz curves.</li>
<li>
<strong>Index_peak_triplets_middle:</strong> each identified signal is defined by three data points. Here the middle data point is given. Note, numbering starts in ascending order from left to right.</li>
<li>
<strong>Index_peak_triplets_left:</strong> as above for the left data point.</li>
<li>
<strong>Index_peak_triplets_right:</strong> as above for the right data point.</li>
<li>
<strong>Peak_triplets_middle:</strong> for each identified signal the position of the middle data point is given in ppm, order from left to right.</li>
<li>
<strong>Peak_triplets_right:</strong> as above for the right data point</li>
<li>
<strong>Peak_triplets_left:</strong> as above for the left datapoint.</li>
<li>
<strong>Integrals:</strong> integrals of deconvoluted signals from left to right as above.</li>
<li>
<strong>Signal_free_region:</strong> e.g., 109.03619, 21.79452, left and right of these borders no signals are expected. Values are in points like x_values but here with 5 instead of 3 decimals.</li>
<li>
<strong>Range_water_signal_ppm:</strong> half width of water signal region i.e., where no signals should be identified in ppm, for example 0.15 ppm.</li>
<li>
<strong>A:</strong> -A*p area under Lorentz-curve, see also integrals, A is always provided as negative number.</li>
<li>
<strong>Lambda:</strong> for all identified signals half width at half height. Is provided as negative value in data points divided by scale-factor i.e., 1000. For example, a value of von 0.00525 corresponds to 5.25 data points. With a spectral width 12019 Hz (this example) and 31072 data points this corresponds to a half linewidth at half height of 0.48 Hz.</li>
<li>
<strong>X_0:</strong> center of all estimated Lorentz curves. Provided in data points divided by scale factor (see also x_values).</li>
<li>
<strong>Scale_factor:</strong> scale factor for x- and y-axis to reduce numerical instabilities, default 1000 and 1000000. Toy example for TSP signal (note numbers will differ for each spectrum): TSP is signal 979, <code>index_peak_triplets_middle[979]=96955</code>, <code>x_0[979]=34.11715</code> (Note <code>(131072-96955)/1000=34.117)</code>, <code>peak_triplets_middle=0.000</code> ppm, <code>lambda[979]=-0.00525</code> corresponds to 0.48 Hz. <code>A[979]=-1.218312</code>; <code>A* Pi=-3.82</code>, <code>integrals[979]=3.82</code>)</li>
</ul><p><em>2024-06-30: Done with commit ab20d64</em></p>
</div>
<div class="section level3">
<h3 id="refactor-9-replace-glc-with-generate_lorentz_curves">REFACTOR-9: Replace glc with generate_lorentz_curves<a class="anchor" aria-label="anchor" href="#refactor-9-replace-glc-with-generate_lorentz_curves"></a></h3>
<p>Replace all <code>glc()</code> calls with calls to <code><a href="reference/deconvolute.html">generate_lorentz_curves()</a></code>.</p>
<p><em>2024-10-01 17:43: Done in branch v1.2.0 with commit 0b52023</em></p>
</div>
<div class="section level3">
<h3 id="refactor-10-replace-all-md1d-with-metabodecon1d-calls">REFACTOR-10: Replace all md1d with MetaboDecon1D calls<a class="anchor" aria-label="anchor" href="#refactor-10-replace-all-md1d-with-metabodecon1d-calls"></a></h3>
<ol style="list-style-type: decimal"><li><p>Implement a function <code>get_MetaboDecon1D_answers</code> that takes the path to the spectra as well as the required <code>sfr</code>, <code>wshw</code> values as as input and returns a vecotr with the corresponding answers to the questions asked by <code>MetaboDecon1D</code>.</p></li>
<li>
<p>Then replace all <code>md1d</code> calls with code snippets as shown below:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">answers</span> <span class="op">&lt;-</span> <span class="fu">get_MetaboDecon1D_answers</span><span class="op">(</span><span class="va">path</span>, sfr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3.5</span>, <span class="fl">3.4</span><span class="op">)</span>, wshw <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">decons</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/evalwith.html">evalwith</a></span><span class="op">(</span>answers <span class="op">=</span> <span class="va">answers</span>, <span class="fu"><a href="reference/MetaboDecon1D.html">MetaboDecon1D</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This makes it directly visible how cumbersome it is to use the old function and also can be applied to any input folder (in contrast to the current <code>md1d</code> function).</p>
</li>
</ol><p><em>2024-10-07 09:21:34: Done in branch v1.2.0 with commits 18db936, 8f01fae and 6bdaa6f</em></p>
</div>
<div class="section level3">
<h3 id="refactor-11-implement-calc_prarp">REFACTOR-11: Implement calc_prarp<a class="anchor" aria-label="anchor" href="#refactor-11-implement-calc_prarp"></a></h3>
<p>Implement a function <code>calc_prarp</code> that takes a <code>decon</code> object and optionally a <code>truepar</code> object. If <code>truepar</code> is not given, it shall be taken from <code>decon$meta$simpar</code>. The function then calculates the PRARP (peak ratio area ratio product) from it, by comparing the estimated parameters with the true parameters.</p>
<p>See function <code>check_decon_quality()</code> for existing code to reuse.</p>
<p><em>Done in 2024/10/08 in branch v1.2.0 with commit 1b7b4c1</em></p>
</div>
<div class="section level3">
<h3 id="refactor-12-write-compliance-tests">REFACTOR-12: Write compliance tests<a class="anchor" aria-label="anchor" href="#refactor-12-write-compliance-tests"></a></h3>
<p>Write testcases for the following functions to check whether they produce results that are compliant with <code><a href="reference/MetaboDecon1D.html">MetaboDecon1D()</a></code>:</p>
<ul class="task-list"><li><label><input type="checkbox" checked><code>deconvolute_ispec()</code></label></li>
<li><label><input type="checkbox" checked><code>deconvolute_ispecs()</code></label></li>
</ul><p><em>Done in 2025/01/13 in branch v1.2.0 with commit 8c4a16b..c6c6e6a</em></p>
</div>
<div class="section level3">
<h3 id="refactor-13-write-prarp-tests">REFACTOR-13: Write PRARP tests<a class="anchor" aria-label="anchor" href="#refactor-13-write-prarp-tests"></a></h3>
<p>Write testcases for the following functions that test for a good PRARP as well as for the correct return type:</p>
<ul class="task-list"><li><label><input type="checkbox" checked><code><a href="reference/MetaboDecon1D.html">MetaboDecon1D()</a></code></label></li>
<li><label><input type="checkbox" checked><code><a href="reference/deconvolute.html">generate_lorentz_curves()</a></code></label></li>
<li><label><input type="checkbox" checked><code><a href="reference/deconvolute.html">deconvolute()</a></code></label></li>
<li><label><input type="checkbox" checked><code>deconvolute_ispec()</code></label></li>
<li><label><input type="checkbox" checked><code>deconvolute_ispecs()</code></label></li>
</ul><p><em>Done in 2025/01/13 in branch v1.2.0 with commit 8c4a16b..c6c6e6a</em></p>
</div>
</div>
<div class="section level2">
<h2 id="cran">CRAN<a class="anchor" aria-label="anchor" href="#cran"></a></h2>
<div class="section level3">
<h3 id="cran-0-omit-functions-for-in-title">CRAN-0: Omit “Functions for” in title<a class="anchor" aria-label="anchor" href="#cran-0-omit-functions-for-in-title"></a></h3>
<p>Omit the redundant “Functions for” in your title.</p>
</div>
<div class="section level3">
<h3 id="cran-1-omit-functions-for-in-description">CRAN-1: Omit “Functions for” in DESCRIPTION<a class="anchor" aria-label="anchor" href="#cran-1-omit-functions-for-in-description"></a></h3>
<p>Do not start the description with “Functions for”, “This package”, package name, title or similar.</p>
</div>
<div class="section level3">
<h3 id="cran-2-explain-acronyms-like-nmr">CRAN-2: Explain acronyms like NMR<a class="anchor" aria-label="anchor" href="#cran-2-explain-acronyms-like-nmr"></a></h3>
<p>Always explain all acronyms in the description text. e.g.: NMR</p>
</div>
<div class="section level3">
<h3 id="cran-3-use-correct-reference-format-in-description">CRAN-3: Use correct reference format in DESCRIPTION<a class="anchor" aria-label="anchor" href="#cran-3-use-correct-reference-format-in-description"></a></h3>
<p>Write references in the description of the DESCRIPTION file in the form <code>authors (year) &lt;doi:...&gt;</code> with no space after ‘doi:’ and angle brackets for auto-linking. (If you want to add a title as well please put it in quotes: “Title”)</p>
</div>
<div class="section level3">
<h3 id="cran-4-explain-return-value-in-function-docs">CRAN-4: Explain return value in function docs<a class="anchor" aria-label="anchor" href="#cran-4-explain-return-value-in-function-docs"></a></h3>
<p>Please add <code>\value</code> to .Rd files regarding exported methods and explain the functions results in the documentation. Please write about the structure of the output (class) and also what the output means. (If a function does not return a value, please document that too, e.g. <code>\value{No return value, called for side effects}</code> or similar). Missing Rd-tags in up to 11 .Rd files, e.g.: <code>combine_peaks.Rd: \value</code>, <code>dohCluster.Rd: \value</code>, …</p>
</div>
<div class="section level3">
<h3 id="cran-5-remove-examples-from-unexported-functions">CRAN-5: Remove examples from unexported functions<a class="anchor" aria-label="anchor" href="#cran-5-remove-examples-from-unexported-functions"></a></h3>
<p>You have examples for unexported functions. Please either omit these examples or export these functions. Examples for unexported function with example: plot_spectrum_superposition_save_as_png().</p>
</div>
<div class="section level3">
<h3 id="cran-6-fix-vignettes">CRAN-6: Fix vignettes<a class="anchor" aria-label="anchor" href="#cran-6-fix-vignettes"></a></h3>
<p>In addition, we see: “Unexecutable code in vignettes/metabodecon.Rmd”: the <code>#</code> should be before <code>"2)"</code> instead of afterwards, I guess.</p>
</div>
<div class="section level3">
<h3 id="cran-7-check-dontrun-examples">CRAN-7: Check dontrun examples<a class="anchor" aria-label="anchor" href="#cran-7-check-dontrun-examples"></a></h3>
<p>Remove <code>dontrun</code> from examples if they are executable in &lt; 5 sec, or create additionally small toy examples to allow automatic testing in &lt; 5 sec. Reason: <code>\dontrun{}</code> should only be used if the example really cannot be executed by the user, e.g. because of missing additional software, missing API keys, etc. That’s why wrapping examples in <code>\dontrun{}</code> adds the comment (“# Not run:”) as a warning for the user. Alternative: You could also replace <code>\dontrun{}</code> with <code>\donttest</code>, if it takes longer than 5 sec to be executed, but it would be preferable to have automatic checks for functions. Otherwise, you can also write some tests.</p>
<p><em>Done in 2025/01/13 in branch v1.2.0 with commit 8c4a16b..c6c6e6a</em></p>
</div>
<div class="section level3">
<h3 id="cran-8-functions-should-not-write-to-disk-by-default">CRAN-8: Functions should not write to disk by default<a class="anchor" aria-label="anchor" href="#cran-8-functions-should-not-write-to-disk-by-default"></a></h3>
<p>Please ensure that your functions do not write by default or in your <code>examples/vignettes/tests</code> in the user’s home filespace (including the package directory and <code><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd()</a></code>). This is not allowed by CRAN policies. Please omit any default path in writing functions. In your examples/vignettes/tests you can write to <code><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir()</a></code>.</p>
<p>ToSc: affected functions are:</p>
<ul><li><code>generate_lorentz_curves</code></li>
<li><code>plot_triplets</code></li>
</ul><p>2024/06/28: Implemented with f5d63f7, 6491b42 and 76b8c4d.</p>
</div>
<div class="section level3">
<h3 id="cran-9-functions-should-not-change-working-dir-or-global-options">CRAN-9: Functions should not change working dir or global options<a class="anchor" aria-label="anchor" href="#cran-9-functions-should-not-change-working-dir-or-global-options"></a></h3>
<p>Please make sure that you do not change the user’s options, par or working directory. If you really have to do so within functions, please ensure with an <em>immediate</em> call of on.exit() that the settings are reset when the function is exited. E.g. <code>R/MetaboDecon1D.R</code>. If you’re not familiar with the function, please check <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">?on.exit</a></code>. This function makes it possible to restore options before exiting a function even if the function breaks. Therefore it needs to be called immediately after the option change within a function.</p>
</div>
</div>
<div class="section level2">
<h2 id="fix">FIX<a class="anchor" aria-label="anchor" href="#fix"></a></h2>
<div class="section level3">
<h3 id="fix-1-prevent-crashes-for-high-smoothing">FIX-1: Prevent crashes for high smoothing<a class="anchor" aria-label="anchor" href="#fix-1-prevent-crashes-for-high-smoothing"></a></h3>
<blockquote>
<p>From: Maximilian Sombke <a href="mailto:Maximilian.Sombke@stud.uni-regensburg.de" class="email">Maximilian.Sombke@stud.uni-regensburg.de</a> Sent: Friday, July 12, 2024 2:59 PM To: Tobias2 Schmidt <a href="mailto:Tobias2.Schmidt@klinik.uni-regensburg.de" class="email">Tobias2.Schmidt@klinik.uni-regensburg.de</a> Subject: Re: Benchmark Metabodecon&gt;</p>
<p>Hey,</p>
<p>sorry für die ganzen mails. Ich wollte es nur so früh wie möglich kommunizieren, falls ich keine Lösung finde. Ich hab glaube ich sogar etwas sehr Interessantes gefunden worüber wir nächste Woche nochmal reden sollten. Als kurze Zusammenfassung:</p>
<p>Meine Vermutung, dass es daran liegt, dass keine Peaks gefunden werden ist nicht richtig. Das tatsächliche Problem ist, dass keine Peaks herausgefiltered werden. Hier mal ein output log:</p>
<pre><code>2024-07-12 14:54:40.96 Starting deconvolution of 1 spectra with 1 core
2024-07-12 14:54:40.96 Starting deconvolution of sim_6
2024-07-12 14:54:40.96 Removing water signal
2024-07-12 14:54:40.96 Removing negative signals
2024-07-12 14:54:40.96 Smoothing signals
2024-07-12 14:54:41.06 Starting peak selection
2024-07-12 14:54:41.06 Detected 4 peaks
2024-07-12 14:54:41.06 Removing peaks with low scores
2024-07-12 14:54:41.06 Removed NA peaks
2024-07-12 14:54:41.06 Initializing Lorentz curves
Error in xl[ds] &lt;- 2 * xc[ds] - xr[ds] (deconvolution.R#63): NAs are not allowed in subscripted assignments</code></pre>
<p>Es findet also 4 peaks aber keiner davon scheint einen score zu haben der niedrig genug ist um herausgefiltered zu werden, wodurch das dann einfach NA ist und das Program crashed. Das passiert hauptsächlich wenn smoothing einen gewissen Threshold überschreitet, z.B. smoothing iterations 20 und smoothing window size 29, bzw. 15 und 39, oder 25 und 25. Delta scheint zu mindest keinen Einfluss hierauf zu haben, es war nur delta = 1 die erste Zeile im Grid in der sollche hohen smoothing kombinationen erreicht werden. Die zu hohen Parameter nicht zu verwenden hat das Problem (zu mindest bis jetzt) gelöst.</p>
<ul><li>Sombke Maximilian</li>
</ul></blockquote>
<p>2024/07/09: Done in branch <code>v1.2.0</code> with commit <code>f5c204cab44b838afe5d5e8c7ace8c74f11b293c</code>.</p>
</div>
<div class="section level3">
<h3 id="doc-1-document-whole-package">DOC-1: Document whole package<a class="anchor" aria-label="anchor" href="#doc-1-document-whole-package"></a></h3>
<p>Document the whole package in vignettes, including chapters about:</p>
<ul class="task-list"><li><label><input type="checkbox" checked>Classes.Rmd</label></li>
<li><label><input type="checkbox" checked>Compatibility.Rmd</label></li>
<li><label><input type="checkbox" checked>Contributing.Rmd</label></li>
<li><label><input type="checkbox" checked>Datasets.Rmd</label></li>
<li><label><input type="checkbox" checked>FAQ.Rmd</label></li>
<li><label><input type="checkbox" checked>MetaboDecon1D.Rmd</label></li>
<li><label><input type="checkbox" checked>Get_Started.Rmd</label></li>
</ul><p><em>Done on 2025/01/14 in branch v1.2.0 with commit 14e0326..71fdc2c</em></p>
</div>
</div>
</div>


  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Tobias Schmidt, Martina Haeckl, Wolfram Gronwald.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

